const cheerio = require("cheerio");
const fs = require("fs");
const axios = require("axios");
const xlsx = require("xlsx");

// Function to fetch data from a given URL
async function fetchData(url) {
  try {
    const response = await axios.get(url);
    return response.data;
  } catch (error) {
    console.error("Error fetching data from", url);
    return null;
  }
}

// Function to extract data using Cheerio
async function extractData(html) {
  const $ = cheerio.load(html);

  const productName = $("#productTitle").text().trim();
  let productPrice = $(".a-price-whole").text().trim() || "N/A";

  productPrice = productPrice.replace(/,/g, "");
  productPrice = parseFloat(productPrice).toFixed(2);

  const stockAvailability =
    $("#availability").text().trim() || "Stock information not available";

  return {
    name: productName,
    price: productPrice,
    stock: stockAvailability,
  };
}

// Function to write data to Excel
function writeToExcel(productsData) {
  const worksheet = xlsx.utils.json_to_sheet(productsData);
  const excelData = xlsx.write(
    { Sheets: { Products: worksheet }, SheetNames: ["Products"] },
    { bookType: "xlsx", type: "buffer" }
  );

  fs.writeFileSync("products.xlsx", excelData);
}

// Main function to orchestrate the scraping process
async function scrapeData() {
  const urls = [
    "https://www.amazon.in/AVVATAR-NITRO-Malai-Creatine-Monohydrate/dp/B09Y5DN7QV/ref=sr_1_7?crid=3NY05WOSRVR4U&dib=eyJ2IjoiMSJ9.CsJEwHdgC6sIYD5FaWcfU8gVLQxjPRUGqZ8QjhOeYv5ICqIhKp-t5M4icndWBB1oXHk8ynJPP4hlBhTNED1tX4EbiifshL0a5_gbAo-p1LCBYGvERkcoepj1_Dc-SI1k397Uq8j1UYQz-Ej3S6OtawlT9gEqWchGAVo_tDXReCu9W4aRn8zM3KirkOvLl9fXYBTIIsWrKvegAbxUBlCXL-yHwwd72J16eL6jVMzAfkpTxtoOdq2Yct4xXSlayBZaZ0k0Eqht8AjmSSNHNc_Yir9LHB-sF1esCtErKcLaFms.wIsY2bR6q5bPe-5Sm7eC7TdmRiVo04ghPFAmE9RrGOY&dib_tag=se&keywords=avvatar+whey+protein&qid=1715442630&sprefix=ava%2Caps%2C231&sr=8-7",
    "https://www.amazon.in/AS-Nutrition-Protein-Concentrate-Unflavoured/dp/B079SZJJDR/ref=sr_1_5?crid=1TVDPA0COTVTN&dib=eyJ2IjoiMSJ9.i8ULqHE70OcNrxbseJA-AGDdSVPC62SGB_ZTihJwl8oi2Q6Mg5n_TJyHSTDn5Qm_nyaO4j1GOl7YTICFbHyTrsRakj4PuHV9pSEnIpYg_bYCocqG9eidb0uMSf1ufuQTmyUka1pnHzEx8bvLfq_BmL3tJyQM0vmDHrYsSSQxYGLc-eMBfNSJT5vWDXBycViuli_G94Bcq8ysA8XtpagR-MTccanXjbeNULjGnnEDc11G8Y3_kVQ4AJHPupMnMXeEu7FTC5az1iZZaImeHQXx525d065DQFjmlGpJyjWn5EM.9df1bNO_UbvBzmlUJbJHJv7oXAkQcOzEEGn3F6WTn7s&dib_tag=se&keywords=asitis+whey+protein+1kg&qid=1715442683&sprefix=asit+is%2Caps%2C251&sr=8-5",
    "https://www.amazon.in/MuscleBlaze-Performance-Certified-Chocolate-servings/dp/B091PPXCVK/ref=sr_1_5?crid=2FU4F21WW5DC0&dib=eyJ2IjoiMSJ9.zTFA3EoqRjeLfQqqPWSuRYw4l8Ui8ctTIBXAkFJ3Rzjt2SqREGxZ-_5zFgmxIlH8art07Fe00VFtUNl0HPW1zGu-oglQLcNA_m10X8_NnZkYkrG9G51Nc62vhEhNpQQeigNh-jTj9tM5A1AwRSJFZAhkgse2wcBBW8X8sX7hPevoaSPvAYOVm9gVW9HbpAUxz7j6BgzZxUVysAd5OKAs2VyC5YALtWmqdGYZOMTRdqEpbc5dKSyv81OxgVFPRrOFY7lrfGNQQUlsYtsHWApuO1n4c5bTz8FXEMKo7tHq3iw.Ziz5VXTEa1kkJmGpUnBCXbWfxh_65YZVjOIntxTwXTg&dib_tag=se&keywords=muscleblaze+whey+protein&qid=1715442716&sprefix=muscle%2Caps%2C275&sr=8-5",
  ];

  const productsData = [];

  for (const url of urls) {
    const html = await fetchData(url);
    if (html) {
      const extractedData = await extractData(html);
      productsData.push(extractedData);
      console.log("Fetched successfull");
    } else {
      console.error("Error in fetching data");
    }
  }

  writeToExcel(productsData);
}

// Call the scrapeData function to start the scraping process
scrapeData();
